<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>m3api-oauth2: Home</title>

    <script defer src="scripts/prettify/prettify.js"></script>
    <script defer src="scripts/prettify/lang-css.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="version-warning.css">
</head>

<body>

<div id="main">

    <p class="version-warning"><strong>Warning:</strong> This is an old version. The latest stable version is <a href="../v1.0.0/index.html">v1.0.0</a>.</p>

    <h1 class="page-title">Home</h1>

    



    


    <h3> </h3>










    




    <section>
        <article><h1>m3api-oauth2</h1>
<p><a href="https://www.npmjs.com/package/m3api-oauth2"><img src="https://img.shields.io/npm/v/m3api-oauth2.svg" alt="npm"></a>
<a href="https://lucaswerkmeister.github.io/m3api-oauth2/"><img src="https://img.shields.io/badge/documentation-informational" alt="documentation"></a></p>
<p>m3api-oauth2 is an extension package for <a href="https://www.npmjs.com/package/m3api">m3api</a>,
making it easy to make requests authenticated via <a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Help:OAuth">OAuth 2.0</a>.</p>
<h2>Usage</h2>
<p>Propose an OAuth 2.0 client on <a href="https://meta.wikimedia.org/wiki/Special:OAuthConsumerRegistration/propose/oauth2">Special:OAuthConsumerRegistration/propose/oauth2</a>,
load its credentials (e.g. from the process envirnoment) into an <code>OAuthClient</code> instance,
and attach that to an m3api session in the request options:</p>
<pre class="prettyprint source lang-js"><code>import Session from 'm3api/node.js';
import { OAuthClient, initOAuthSession, completeOAuthSession } from 'm3api-oauth2';

const session = new Session( 'en.wikipedia.org', {}, {
	userAgent: 'm3api-oauth2-README-example',
	'm3api-oauth2/client': new OAuthClient(
		process.env.OAUTH_CLIENT_ID,
		process.env.OAUTH_CLIENT_SECRET,
	),
} );
</code></pre>
<p>Initialize the m3api session as an OAuth session,
and generate the authorization URL for the user:</p>
<pre class="prettyprint source lang-js"><code>console.log( await initOAuthSession( session ) );
</code></pre>
<p>Send the user to that URL (e.g. via a redirect from your application).
When they choose to authorize your app, they will be redirected back to you;
use that URL to finish setting up the OAuth session:</p>
<pre class="prettyprint source lang-js"><code>await completeOAuthSession( session, callbackUrl );
</code></pre>
<p>(The <code>callbackUrl</code> should look like the URL you registered the OAuth client with,
plus a <code>?code</code> parameter generated by MediaWiki.)</p>
<p>Now you should be able to make requests using the OAuth session:</p>
<pre class="prettyprint source lang-js"><code>console.log( await session.request( {
	action: 'query',
	meta: 'userinfo',
} ) );
</code></pre>
<p>This example assumes that you can keep the original <code>session</code> instance alive,
which may be true for a CLI utility, but probably not a web-based application.
You can serialize the OAuth session and store the result in the user session,
saved in some kind of session store:</p>
<pre class="prettyprint source lang-js"><code>const serialization = serializeOAuthSession( session );
// store serialization (or JSON.stringify( serialization )) somewhere
// ...next request...
// get serialization from somewhere (possibly via JSON.parse())
deserializeOAuthSession( session, serialization );
</code></pre>
<p>Note that you shouldn’t make the serialization directly available to the user
(e.g., you shouldn’t put it directly in a cookie),
since that would allow the user to extract the access token and impersonate your application.
Use a session store instead, e.g. based on Redis if you’re on Wikimedia Toolforge.</p>
<h3>Non-confidential clients</h3>
<p>MediaWiki also supports non-confidential clients,
i.e. clients that are unable to keep a client secret,
such as in-browser apps or mobile apps.
Whether a client is confidential or not is specified when the client is registered.</p>
<p>MediaWiki still generates a client secret for non-confidential clients,
and as far as this library is concerned,
you can use the client with or without its client secret:</p>
<pre class="prettyprint source lang-js"><code>const client = new OAuthClient( clientId, clientSecret );
// or:
const client = new OAuthClient( clientId );

// both support:
const session = new Session( 'en.wikipedia.org', {}, {
	'm3api-oauth2/client': client,
} );
</code></pre>
<p>Whether a non-confidential client should be used with or without its secret
is currently up for discussion in <a href="https://phabricator.wikimedia.org/T323867">T323867</a>;
note that without a client secret,
the session currently cannot be refreshed (<a href="https://phabricator.wikimedia.org/T323855">T323855</a>),
so in that case you would need to go through the authorization flow again after ca. four hours.</p>
<h2>Terminology</h2>
<p>There are several different kinds of “session” relevant to this package;
the documentation tries to use the following terms consistently:</p>
<dl>
<dt>m3api session</dt>
<dd>
<p>An instance of the m3api <code>Session</code> class.
Can be used to make API requests.</p>
</dd>
<dt>OAuth session</dt>
<dd>
<p>An m3api session that has been enhanced by this package.
Any requests it makes (using the usual m3api methods, <code>request()</code> etc.)
are authenticated using OAuth.
A non-OAuth m3api session is transformed into an OAuth session
using either <code>initOAuthSession()</code> (from scratch)
or <code>deserializeOAuthSession()</code> (based on an existing serialization).</p>
</dd>
<dt>user session</dt>
<dd>
<p>Some kind of data store associated with the user of your application,
usually provided by the web framework you use (e.g. <a href="https://expressjs.com/en/resources/middleware/session.html">express-session</a>).
You would use this to store the serialization of the session (<code>serializeOAuthSession()</code>),
as well as any other data you like.</p>
</dd>
</dl>
<h2>Compatibility</h2>
<p>m3api-oauth2 is <em>not</em> compatible with all platforms supported by m3api;
specifically, it additionally requires support for dynamic imports,
which most browsers supported a handful of releases later than the static imports required by m3api.
It also requires the Web Crypto API methods <code>crypto.getRandomValues()</code> and <code>crypto.subtle.digest()</code>,
but they are available in all m3api-supported platforms.</p>
<h2>License</h2>
<p>Published under the <a href="https://spdx.org/licenses/ISC.html">ISC License</a>.
By contributing to this software,
you agree to publish your contribution under the same license.</p></article>
    </section>






</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="OAuthClient.html">OAuthClient</a></li></ul><h3>Global</h3><ul><li><a href="global.html#completeOAuthSession">completeOAuthSession</a></li><li><a href="global.html#deserializeOAuthSession">deserializeOAuthSession</a></li><li><a href="global.html#handleInvalidAuthorizationError">handleInvalidAuthorizationError</a></li><li><a href="global.html#initOAuthSession">initOAuthSession</a></li><li><a href="global.html#refreshOAuthSession">refreshOAuthSession</a></li><li><a href="global.html#serializeOAuthSession">serializeOAuthSession</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a>
</footer>

<script>document.addEventListener('DOMContentLoaded', function () { prettyPrint(); });</script>
<script async src="scripts/linenumber.js"></script>
</body>
</html>