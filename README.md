# m3api-oauth2

m3api-oauth2 is an extension package for [m3api][],
making it easy to make requests authenticated via [OAuth 2.0][OAuth].

## Usage

Create an OAuth client containing your credentials (e.g. loaded from the process environment),
and attach it to an m3api session in the request options:

```js
import Session from 'm3api/node.js';
import { OAuthClient, initOAuthSession, completeOAuthSession } from 'm3api-oauth2';

const session = new Session( 'en.wikipedia.org', {}, {
	userAgent: 'm3api-oauth2-README-example',
	'm3api-oauth2/client': new OAuthClient(
		process.env.OAUTH_CLIENT_ID,
		process.env.OAUTH_CLIENT_SECRET,
	),
} );
```

Initialize the m3api session as an OAuth session,
and generate the authorization URL for the user:

```js
console.log( await initOAuthSession( session ) );
```

Send the user to that URL (e.g. via a redirect from your application).
When they choose to authorize your app, they will be redirected back to you;
use that URL to finish setting up the OAuth session:

```js
await completeOAuthSession( session, callbackUrl );
```

(The `callbackUrl` should look like the URL you registered the OAuth client with,
plus a `?code` parameter generated by MediaWiki.)

Now you should be able to make requests using the OAuth session:

```js
console.log( await session.request( {
	action: 'query',
	meta: 'userinfo',
} ) );
```

This example assumes that you can keep the original `session` instance alive,
which may be true for a CLI utility, but probably not a web-based application.
You can serialize the OAuth session and store the result in the user session,
saved in some kind of session store:

```js
const serialization = serializeOAuthSession( session );
// store serialization (or JSON.stringify( serialization )) somewhere
// ...next request...
// get serialization from somewhere (possibly via JSON.parse())
deserializeOAuthSession( session, serialization );
```

Note that you shouldn’t make the serialization directly available to the user
(e.g., you shouldn’t put it directly in a cookie),
since that would allow the user to extract the access token and impersonate your application.
Use a session store instead, e.g. based on Redis if you’re on Wikimedia Toolforge.

## Terminology

There are several different kinds of “session” relevant to this package;
the documentation tries to use the following terms consistently:

<dl>
<dt>m3api session</dt>
<dd>

An instance of the m3api `Session` class.
Can be used to make API requests.

</dd>
<dt>OAuth session</dt>
<dd>

An m3api session that has been enhanced by this package.
Any requests it makes (using the usual m3api methods, `request()` etc.)
are authenticated using OAuth.
A non-OAuth m3api session is transformed into an OAuth session
using either `initOAuthSession()` (from scratch)
or `deserializeOAuthSession()` (based on an existing serialization).

</dd>
<dt>user session</dt>
<dd>

Some kind of data store associated with the user of your application,
usually provided by the web framework you use (e.g. [express-session][]).
You would use this to store the serialization of the session (`serializeOAuthSession()`),
as well as any other data you like.

</dd>
</dl>

## Limitations

Non-confidential clients (using PKCE) are not yet supported.
A client secret is required.

The resulting access token is typically only valid for four hours;
there is no support for refreshing it yet, neither automatically nor manually.

## License

Published under the [ISC License][].
By contributing to this software,
you agree to publish your contribution under the same license.

[m3api]: https://www.npmjs.com/package/m3api
[OAuth]: https://www.mediawiki.org/wiki/Special:MyLanguage/Help:OAuth
[express-session]: https://expressjs.com/en/resources/middleware/session.html
[ISC License]: https://spdx.org/licenses/ISC.html
