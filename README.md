# m3api-oauth2

m3api-oauth2 is an extension package for [m3api][],
making it easy to make requests authenticated via [OAuth 2.0][OAuth].

## Usage

Create an OAuth client containing your credentials (e.g. loaded from the process environment),
and attach it to an m3api session in the request options:

```js
import Session from 'm3api/node.js';
import { OAuthClient, initOAuthSession, completeOAuthSession } from 'm3api-oauth2';

const session = new Session( 'en.wikipedia.org', {}, {
	userAgent: 'm3api-oauth2-README-example',
	'm3api-oauth2/client': new OAuthClient(
		process.env.OAUTH_CLIENT_ID,
		process.env.OAUTH_CLIENT_SECRET,
	),
} );
```

Generate the authorization URL for the user:

```js
console.log( await initOAuthSession( session ) );
```

Send the user to that URL (e.g. via a redirect from your application).
When they choose to authorize your app, they will be redirected back to you;
use that URL to finish setting up the session:

```js
await completeOAuthSession( session, callbackUrl );
```

(The `callbackUrl` should look like the URL you registered the OAuth client with,
plus a `?code` parameter generated by MediaWiki.)

Now you should be able to make requests using the session:

```js
console.log( await session.request( {
	action: 'query',
	meta: 'userinfo',
} ) );
```

This example assumes that you can keep the original `session` instance alive,
which may be true for a CLI utility, but probably not a web-based application.
You can serialize the session and store the result in some kind of session store:

```js
const serialization = serializeOAuthSession( session );
// store serialization (or JSON.stringify( serialization )) somewhere
// ...next request...
// get serialization from somewhere (possibly via JSON.parse())
deserializeOAuthSession( session, serialization );
```

Note that you shouldn’t make the serialization directly available to the user
(e.g., you shouldn’t put it directly in a cookie),
since that would allow the user to extract the access token and impersonate your application.
Use a session store instead, e.g. based on Redis if you’re on Wikimedia Toolforge.

## Limitations

Non-confidential clients (using PKCE) are not yet supported.
A client secret is required.

The resulting access token is typically only valid for four hours;
there is no support for refreshing it yet, neither automatically nor manually.

## License

Published under the [ISC License][].
By contributing to this software,
you agree to publish your contribution under the same license.

[m3api]: https://www.npmjs.com/package/m3api
[OAuth]: https://www.mediawiki.org/wiki/Special:MyLanguage/Help:OAuth
[ISC License]: https://spdx.org/licenses/ISC.html
