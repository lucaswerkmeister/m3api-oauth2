# m3api-oauth2

m3api-oauth2 is an extension package for [m3api][],
making it easy to make requests authenticated via [OAuth 2.0][OAuth].

## Usage

Create an OAuth client containing your credentials (e.g. loaded from the process environment),
and attach it to an m3api session in the request options:

```js
import Session from 'm3api/node.js';
import { OAuthClient, getAuthorizeUrl, handleCallback } from 'm3api-oauth2';

const session = new Session( 'en.wikipedia.org', {}, {
	userAgent: 'm3api-oauth2-README-example',
	'm3api-oauth2/client': new OAuthClient(
		process.env.OAUTH_CLIENT_ID,
		process.env.OAUTH_CLIENT_SECRET,
	),
} );
```

Generate the authorization URL for the user:

```js
console.log( await getAuthorizeUrl( session ) );
```

Send the user to that URL (e.g. via a redirect from your application).
When they choose to authorize your app, they will be redirected back to you;
use that URL to finish setting up the session:

```js
await handleCallback( session, callbackUrl );
```

(The `callbackUrl` should look like the URL you registered the OAuth consumer with,
plus a `?code` parameter generated by MediaWiki.)

Now you should be able to make requests using the session:

```js
console.log( await session.request( {
	action: 'query',
	meta: 'userinfo',
} ) );
```

## Limitations

Non-confidential consumers (using PKCE) are not yet supported.
A client secret is required.

The resulting access token is typically only valid for four hours;
there is no support for refreshing it yet, neither automatically nor manually.

You must keep the original `session` instance alive;
there is no support for “serializing” it yet,
in a way that could be associated with a broader user session.

## License

Published under the [ISC License][].
By contributing to this software,
you agree to publish your contribution under the same license.

[m3api]: https://www.npmjs.com/package/m3api
[OAuth]: https://www.mediawiki.org/wiki/Special:MyLanguage/Help:OAuth
[ISC License]: https://spdx.org/licenses/ISC.html
